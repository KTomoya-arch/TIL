## 授業

- ENI は EC2 に紐づいているリソース。
- A レコードをキャッシュするのはキャッシュリゾルバ
- ゾーン情報を管理しているのが権威 DNS サーバ。

### リザーブドインスタンス

- 一年と三年が選択できるが見通しが立たないことが多いので基本一年にする。
- 前払いなし、一部前払い、全額前払いが存在する。
- 2*2*3= 12 通りのパターンが存在する

## 宿題

curl で実行し、意味を調べる。

```
< HTTP/1.1 200 OK
< Server: nginx/1.25.1
< Date: Mon, 10 Jul 2023 09:56:33 GMT
< Content-Type: text/html
< Content-Length: 615
< Last-Modified: Tue, 13 Jun 2023 15:08:10 GMT
< Connection: keep-alive
```

- < HTTP/1.1 200 OK
  HTTP プロトロコルで GET リクエストを送信し、200 のレスポンスが返却されたことを意味している。成功している。

- Server: nginx/1.25.1
  サーバーの種類とバージョンを示しており、nginx で 1.25.1 のバージョンが使用されている。

- < Date: Mon, 10 Jul 2023 09:56:33 GMT
  レスポンスが生成された日時を示しており、7/10 の月曜日、GMT で 9:56:33、JST だと 18:56:33 を指している。

- < Content-Type: text/html
  レスポンスのデータの種類を示す Content-Type ヘッダーである。
  この場合はデータはテキスト形式の html コンテンツであることを示す。

- < Content-length: 615
  レスポンス本文の長さをバイト単位で示している。この場合は 615 バイトに相当する。

- < Last-Modified: Tue, 13 Jun 2023 15:08:10 GMT
  コンテンツが最後に変更された日時を指す。

- Connection: keep-alive
  一度接続したコネクションを維持して再利用可能な状態にしておくことを意味している。

1. EC2 の設定と挙動を理解するために、解説手順の動作確認でアクセスした 1 回のリクエストについて、応答結果を表にまとめる。
   ドメイン名によるリクエストが dns で対応する A レコードにセットされている ElasticIP であると解釈され、
   ElasticIP が紐づいている EC2 インスタンスに届き、最終的にはその中で動いているサーバーである nginx が HTTP リクエスト 200 を返している。

2. EC2 インスタンスの料金体系について

- １ヶ月連続で動かしていた場合
  - EC2 インスタンス
    AsiaTokyo リージョンでは、`t2.micro`を動かすと１時間当たり、`$0.0152`必要となる。
    0.0152*24*30= $10.944 となる。
  - EBS ボリューム
    https://aws.amazon.com/jp/ebs/pricing/
    $0.096/GB 月なので、8GB だから、$0.768 ？あまり自信ない
  - EIP
    EIP が一つのみで起動している EC2 インスタンスに割り当てられている場合は料金は発生しない、よって$0。
- １ヶ月連続で止めていた場合
  - EC2 インスタンス
    課金は発生しない。
  - EBS ボリューム
    プロビジョニングした分は発生するので、上記と変わらず、$0.768
  - EIP
    停止している場合は費用が発生する。
    $0.005/h 発生するので、$3.6
    無料利用枠はない

3. オンデマンドのインスタンスを使っているがそれ以外にリザーブドインスタンス、スポットインスタンスも存在する。
   オンデマンドと比較して、それぞれ割引率はどれぐらいか？

   - リザーブドインスタンスだと、1 年で見積もると 32%の割引、3 年で見積もると 51%の割引。

   - スポットインスタンスだと、$0.0046/h で利用できるので 70%程度の割引率がある。

4. インターネット公開するために、EC2 インスタンスを Protected Subnet に作ってダメな理由は？
   NAT Gateway を用意しなければならないから？(正直わからん)

5. セキュリティグループは TCP の何番ポートを公開したか。
   HTTP の 80 番ポート。

- SSH
  22 番(TCP/UDP)
- DNS
  53 番(TCP/UDP)
- HTTPS
  443 番(TCP/UDP)
- MySQL
  3306 番(TCP)
- PostgreSQL
  5432 番(TCP)

6. 固定にこだわる理由
   EC2 はパブリックな IP が割り当てられるが、インスタンスが停止や再起動をすると変更される可能性があるため。
   EIP で固定を使用することで同じ IP が保持されるので DNS の変更やアプリが依存していても困らなくなる。
   ブラックリストに登録されていたりした際の

7. EC2 から S3 ファイルアップロードをする権限を追加したいならどんな権限を追加すれば良いか？
   https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_examples_s3_rw-bucket.html
   AllObjectActions という s3 に対して Get,Delete,Put およびその他の Object で終わる S3 アクションを使用可能なポリシーを Role に追加する。

8. EC2 の停止 → 起動、再起動の違いは？
   https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html#lifecycle-differences

9. CPU クレジット(T 系のインスタンスに存在する)
   他のインスタンスとは異なり、ベースラインというあらかじめ決められた CPU 使用率が定義されていて、その CPU 使用率を超えた CPU 使用率が使用可能であるバースト機能を使っている際に消費されるものが CPU クレジットである。
   CPU クレジットは無くなってしまうとベースライン以下の性能しか出なくなるまたは追加で課金が発生する。

無制限モード
クレジットの消費を適切に管理しない場合に、継続してパフォーマンスが発揮できなくなるという制限があるので追加料金を払うことで無制限にバースト可能になる
T2/T3無制限モードがある(アカウントレベル)

CPU クレジットは vCPU 時間の単位を指していて、以下のように計算することができます。

1 CPU クレジット = 1 vCPU × 100% 使用率 × 1 分
1 CPU クレジット = 1 vCPU × 50% 使用率 × 2 分
1 CPU クレジット = 2 vCPU × 25% 使用率 × 2 分

10. EBS 最適化とは何か？ t2.micro は有効にできるか？ t3.micro は有効にできるか？

- EBS 最適化とは何か？
  https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-optimized.html
  EBS 最適化は EBS I/O とその他の EC2 インスタンスからのトラフィック間の競合を最小限にし、EBS ボリュームへの I/O を
  高パフォーマンスすることを指している。EC2 と EBS を繋いでいるネットワークを別々にし EBS 専用のネットワーク経路で EC2 と繋ぐ。
- t2.micro は有効にできるか？t3.micro は有効にできるか？
  下記の CLI でサポート対象のインスタンスタイプを表示可能である。

  ```
  aws ec2 describe-instance-types \
  --query 'InstanceTypes[].{InstanceType:InstanceType,"MaxBandwidth(Mb/s)":EbsInfo.EbsOptimizedInfo.MaximumBandwidthInMbps,MaxIOPS:EbsInfo.EbsOptimizedInfo.MaximumIops,"MaxThroughput(MB/s)":EbsInfo.EbsOptimizedInfo.MaximumThroughputInMBps}' \
  --filters Name=ebs-info.ebs-optimized-support,Values=default --output=table
  ```

  - t2.micro
    有効にできない。

  ```
  aws ec2 describe-instance-types \
  --query 'InstanceTypes[].{InstanceType:InstanceType,"MaxBandwidth(Mb/s)":EbsInfo.EbsOptimizedInfo.MaximumBandwidthInMbps,MaxIOPS:EbsInfo.EbsOptimizedInfo.MaximumIops,"MaxThroughput(MB/s)":EbsInfo.EbsOptimizedInfo.MaximumThroughputInMBps}' \
  --filters Name=ebs-info.ebs-optimized-support,Values=default --output=table | grep 't2.micro'
  ```

  - t3.micro
    有効にできる。

  ```
  aws ec2 describe-instance-types \
  --query 'InstanceTypes[].{InstanceType:InstanceType,"MaxBandwidth(Mb/s)":EbsInfo.EbsOptimizedInfo.MaximumBandwidthInMbps,MaxIOPS:EbsInfo.EbsOptimizedInfo.MaximumIops,"MaxThroughput(MB/s)":EbsInfo.EbsOptimizedInfo.MaximumThroughputInMBps}' \
  --filters Name=ebs-info.ebs-optimized-support,Values=default --output=table | grep 't3.micro'

  |  t3.micro         |  2085                |  11800   |  260.625              |
  ```

11. EBS ボリュームタイプの種類は何があるか？ 特に SSD の種類の違いについて調べてください。<br>
    https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-volume-types.html#vol-type-prev<br>
    ３種類存在する。

    1. ソリッドステートドライブ (SSD) ボリューム
    2. ハードディスクドライブ (HDD) ボリューム
    3. 旧世代のボリューム

SSD ボリュームは、汎用 SSD ボリュームと Provisioned IOPS SSD ボリュームに分かれる。
ざっくり言うなら汎用 SSD ボリュームは性能面で Provisioned IOPS SSD ボリュームに劣るのでライトな使い方(本番環境以外)で使用するのが望ましそう。
io2BlockExpress は非常に高スペック。

- 汎用 SSD ボリュームはタイプが gp3,gp2 に分かれ、ユースケースとしては中規模の単一 DB・開発/テスト環境等向け、ボリュームサイズは 1GiB〜16TiB、
  ボリュームあたり最大 16, 000IOPS、ボリュームあたりの最大スループット 1,000MiB/s 250MiB/s で EBS マルチアタッチサポートは対象外となっている。
- Provisioned IOPS SSD ボリュームでは、io2BlockExpress が 99.999(ファイブナイン)でユースケースはミリ秒のレイテンシ、持続的 IOPS パフォーマンス、64,000IOPS または 1,000MiB/s を超えるスループット、4GiB〜64TiB の ボリュームサイズ・・・などなど

## 応用課題

各意味
- connection: keep-aliveの意味はTCPコネクションをを基本的には毎回接続し切るということを繰り返すが繰り返すが
```
$ curl -IXGET http://ec2.porker.ink/

HTTP/1.1 200 OK
Server: nginx/1.25.1
Date: Sun, 23 Jul 2023 07:53:22 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 13 Jun 2023 15:08:10 GMT
Connection: keep-alive
ETag: "6488865a-267"
Accept-Ranges: bytes
```
